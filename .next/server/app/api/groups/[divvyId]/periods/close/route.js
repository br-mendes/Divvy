"use strict";(()=>{var e={};e.id=6897,e.ids=[6897],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},67370:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>f,requestAsyncStorage:()=>m,routeModule:()=>c,serverHooks:()=>v,staticGenerationAsyncStorage:()=>g});var s={};r.r(s),r.d(s,{POST:()=>l});var o=r(49303),i=r(88716),n=r(60670),a=r(87070),u=r(19692),d=r(95347),p=r(6659);async function l(e,{params:t}){let r=(0,u.$)(),s=t.divvyId,{session:o,role:i,isCreator:n}=await (0,d.q)(s);if(!o?.user)return a.NextResponse.json({error:"Unauthorized"},{status:401});if(!((0,p.e)(o.user.email)||n||"admin"===i))return a.NextResponse.json({error:"Forbidden"},{status:403});let l=await e.json(),c=String(l?.from??"").trim(),m=String(l?.to??"").trim();if(!c||!m)return a.NextResponse.json({error:"from e to s\xe3o obrigat\xf3rios (YYYY-MM-DD)"},{status:400});let{data:g,error:v}=await r.from("expenses").select("id, payeruserid, amount_cents, currency, expense_date").eq("divvyid",s).gte("expense_date",c).lte("expense_date",m);if(v)return a.NextResponse.json({error:v.message},{status:500});let x=(g??[]).map(e=>e.id),f=[];if(x.length){let{data:e,error:t}=await r.from("expense_splits").select("expenseid, userid, amount_cents").eq("divvyid",s).in("expenseid",x);if(t)return a.NextResponse.json({error:t.message},{status:500});f=e??[]}let{data:_,error:y}=await r.from("payments").select("from_userid, to_userid, amount_cents, paid_at").eq("divvyid",s).gte("paid_at",c).lte("paid_at",m);if(y)return a.NextResponse.json({error:y.message},{status:500});let{data:b,error:w}=await r.from("divvymembers").select("userid, email, role").eq("divvyid",s);if(w)return a.NextResponse.json({error:w.message},{status:500});let q=new Map,j=new Map,h=new Map,R=new Map,N=g?.[0]?.currency??"BRL";for(let e of g??[]){let t=String(e.payeruserid),r=Number(e.amount_cents)||0;q.set(t,(q.get(t)??0)+r)}for(let e of f??[]){let t=String(e.userid),r=Number(e.amount_cents)||0;j.set(t,(j.get(t)??0)+r)}for(let e of _??[]){let t=String(e.from_userid),r=String(e.to_userid),s=Number(e.amount_cents)||0;h.set(t,(h.get(t)??0)+s),R.set(r,(R.get(r)??0)+s)}let S=(b??[]).map(e=>{let t=e.userid,r=q.get(t)??0,s=j.get(t)??0,o=h.get(t)??0,i=R.get(t)??0;return{userid:t,email:e.email,paid_cents:r,owed_cents:s,net_cents:r-s+o-i}}),C={from:c,to:m,currency:N,totals:{expenses_cents:(g??[]).reduce((e,t)=>e+(Number(t.amount_cents)||0),0),payments_cents:(_??[]).reduce((e,t)=>e+(Number(t.amount_cents)||0),0)},counts:{expenses:(g??[]).length,splits:(f??[]).length,payments:(_??[]).length},balances:S},{data:M,error:k}=await r.from("divvy_periods").insert({divvyid:s,period_from:c,period_to:m,status:"closed",closed_by:o.user.id,snapshot:C}).select("*").single();return k?a.NextResponse.json({error:k.message},{status:409}):a.NextResponse.json({period:M},{status:201})}let c=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/groups/[divvyId]/periods/close/route",pathname:"/api/groups/[divvyId]/periods/close",filename:"route",bundlePath:"app/api/groups/[divvyId]/periods/close/route"},resolvedPagePath:"C:\\Users\\bruno\\Documents\\GitHub\\Divvy\\app\\api\\groups\\[divvyId]\\periods\\close\\route.ts",nextConfigOutput:"export",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:v}=c,x="/api/groups/[divvyId]/periods/close/route";function f(){return(0,n.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:g})}},6659:(e,t,r)=>{r.d(t,{E:()=>s,e:()=>o});let s=["falecomdivvy@gmail.com","brunoafonso.mendes@gmail.com"].map(e=>e.toLowerCase().trim());function o(e){return!!e&&s.includes(e.toLowerCase().trim())}},95347:(e,t,r)=>{r.d(t,{q:()=>o});var s=r(19692);async function o(e){let t=(0,s.$)(),{data:{session:r}}=await t.auth.getSession();if(!r?.user)return{session:null,role:null,isCreator:!1};let{data:o}=await t.from("divvies").select("id, creatorid").eq("id",e).single(),i=!!o&&o.creatorid===r.user.id,{data:n}=await t.from("divvymembers").select("role").eq("divvyid",e).eq("userid",r.user.id).single();return{session:r,role:n?.role??null,isCreator:i}}},19692:(e,t,r)=>{r.d(t,{$:()=>i});var s=r(71615),o=r(20344);function i(){return(0,o.createServerClient)("https://jpgifiumxqzbroejhudc.supabase.co","sb_publishable_RWrlgQRxQHCQ45cEIia_ug_OT9ouCwi",{cookies:{get:e=>s.cookies().get(e)?.value,set(e,t,r){(0,s.cookies)().set(e,t,r)},remove(e,t){(0,s.cookies)().set(e,"",{...t,maxAge:0})}}})}}};var t=require("../../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[9276,5972,7857,958],()=>r(67370));module.exports=s})();